<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - WA Gateway</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/device.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/toast.css?v=3.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fab fa-whatsapp"></i>
                <span>WA<span class="highlight">Gateway</span></span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i>
                    <span>Dashboard</span></a></div>
            <div class="nav-item"><a href="devices.html" class="nav-link"><i class="fas fa-mobile-alt"></i>
                    <span>Devices</span></a></div>
            <div class="nav-item"><a href="messages.html" class="nav-link"><i class="fas fa-paper-plane"></i>
                    <span>Messages</span></a></div>
            <div class="nav-item"><a href="contacts.html" class="nav-link"><i class="fas fa-address-book"></i>
                    <span>Contacts</span></a></div>
            <div class="nav-section">AUTOMATION</div>
            <div class="nav-item"><a href="auto-reply.html" class="nav-link"><i class="fas fa-robot"></i> <span>Auto
                        Reply</span></a></div>
            <div class="nav-item"><a href="webhooks.html" class="nav-link"><i class="fas fa-link"></i>
                    <span>Webhooks</span></a></div>
            <div class="nav-section">ACCOUNT</div>
            <div class="nav-item"><a href="subscription.html" class="nav-link"><i class="fas fa-crown"></i>
                    <span>Subscription</span></a></div>
            <div class="nav-item"><a href="settings.html" class="nav-link active"><i class="fas fa-cog"></i>
                    <span>Settings</span></a></div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-details">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-email" id="userEmail">user@email.com</div>
                </div>
                <button class="logout-btn" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="header-content">
                <div>
                    <h1 class="page-title">Pengaturan</h1>
                    <p class="page-subtitle">Kelola akun dan preferensi aplikasi</p>
                </div>
            </div>
        </div>



        <div class="settings-grid">
            <!-- Navigation -->
            <div class="settings-nav">
                <button class="settings-tab active" onclick="switchTab('profile')">
                    <i class="fas fa-user-circle"></i> Profil Akun
                </button>
                <button class="settings-tab" onclick="switchTab('security')">
                    <i class="fas fa-lock"></i> Keamanan
                </button>
                <button class="settings-tab" onclick="switchTab('app')">
                    <i class="fas fa-sliders-h"></i> Aplikasi
                </button>
            </div>

            <!-- Content Panels -->
            <div class="settings-content">
                <!-- Profile Panel -->
                <div id="section-profile" class="settings-panel active">
                    <div class="settings-section">
                        <h2 class="section-title">Informasi Pribadi</h2>
                        <div class="profile-header">
                            <div class="profile-avatar-large" id="profileAvatarLarge">U</div>
                            <div>
                                <button class="btn btn-outline btn-sm"
                                    onclick="document.getElementById('avatarInput').click()">Ubah Foto</button>
                                <input type="file" id="avatarInput" hidden accept="image/*"
                                    onchange="handleAvatarUpload(this)">
                            </div>
                        </div>
                        <form id="profileForm">
                            <div class="form-group">
                                <label class="form-label">Nama Depan</label>
                                <input type="text" id="profileFirstName" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nama Belakang</label>
                                <input type="text" id="profileLastName" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="profileEmail" class="form-input" readonly disabled
                                    style="background:#f1f5f9;">
                                <small class="text-xs text-gray-500">Email tidak dapat diubah</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                        </form>
                    </div>
                </div>

                <!-- Security Panel -->
                <div id="section-security" class="settings-panel">
                    <div class="settings-section">
                        <h2 class="section-title">Ubah Password</h2>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label class="form-label">Password Saat Ini</label>
                                <input type="password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password Baru</label>
                                <input type="password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Konfirmasi Password Baru</label>
                                <input type="password" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </form>
                    </div>
                </div>



                <!-- App Panel -->
                <div id="section-app" class="settings-panel">
                    <div class="settings-section">
                        <h2 class="section-title">Preferensi Aplikasi</h2>

                        <div class="form-group">
                            <label class="form-label">Tema</label>
                            <select class="form-input" id="themeSelect">
                                <option value="light">Terang (Default)</option>
                                <option value="dark">Gelap (Coming Soon)</option>
                                <option value="system">Ikuti Sistem</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Bahasa</label>
                            <select class="form-input" id="langSelect">
                                <option value="id">Bahasa Indonesia</option>
                                <option value="en">English</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Timezone</label>
                            <select class="form-input" disabled>
                                <option value="asia/jakarta">Asia/Jakarta (GMT+7)</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="saveAppPrefs()">Simpan Preferensi</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/toast.js"></script>
    <script src="js/api.js"></script>
    <script>
        requireAuth();


        // Global State
        let currentApiKey = null;
        let isKeyVisible = false;

        // Init
        window.addEventListener('load', async () => {
            await loadProfile();
        });

        async function loadProfile() {
            try {
                const response = await UsersAPI.getProfile();
                const user = response.user;

                // Update Local Storage just in case
                localStorage.setItem('user', JSON.stringify(user));

                // Populate UI
                if (user.firstName) {
                    const fullName = `${user.firstName} ${user.lastName || ''}`;
                    document.getElementById('userName').textContent = fullName;
                    document.getElementById('userEmail').textContent = user.email;

                    if (user.profilePicture) {
                        const style = `url("${user.profilePicture}")`; // Use double quotes
                        console.log('Loading avatar URL:', user.profilePicture);

                        // Settings Preview Update
                        const mainAvatar = document.getElementById('profileAvatarLarge');
                        mainAvatar.textContent = '';
                        // Reset first to force reload
                        mainAvatar.style.backgroundImage = 'none';
                        mainAvatar.offsetHeight; // Request reflow

                        mainAvatar.style.backgroundImage = style;
                        mainAvatar.style.backgroundSize = 'cover';
                        mainAvatar.style.backgroundPosition = 'center';
                        mainAvatar.style.backgroundColor = 'var(--gray-200)'; // Fallback color

                        // Update Sidebar
                        const sidebarAvatar = document.getElementById('userAvatar');
                        if (sidebarAvatar) {
                            sidebarAvatar.textContent = '';
                            sidebarAvatar.style.backgroundImage = style;
                            sidebarAvatar.style.backgroundSize = 'cover';
                            sidebarAvatar.style.backgroundPosition = 'center';
                        }
                    } else {
                        const initial = user.firstName.charAt(0).toUpperCase();

                        const sidebarAvatar = document.getElementById('userAvatar');
                        sidebarAvatar.style.backgroundImage = 'none';
                        sidebarAvatar.textContent = initial;

                        const mainAvatar = document.getElementById('profileAvatarLarge');
                        mainAvatar.style.backgroundImage = 'none';
                        mainAvatar.textContent = initial;
                    }

                    // Form Fields
                    document.getElementById('profileFirstName').value = user.firstName;
                    document.getElementById('profileLastName').value = user.lastName || '';
                    document.getElementById('profileEmail').value = user.email;
                }

                // Store API Key
                currentApiKey = user.apiKey;

            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('danger', 'Gagal memuat profil');
            }
        }

        async function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showAlert('danger', 'Ukuran foto maksimal 2MB');
                    input.value = '';
                    return;
                }

                // Show preview immediately
                const reader = new FileReader();
                reader.onload = function (e) {
                    const avatar = document.getElementById('profileAvatarLarge');
                    avatar.textContent = '';
                    avatar.style.backgroundImage = `url('${e.target.result}')`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                }
                reader.readAsDataURL(file);

                // Create form data
                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    // Show loading state on button
                    const btn = input.previousElementSibling;
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                    // API Call
                    const response = await UsersAPI.uploadAvatar(formData);

                    // Update Local Storage
                    let user = JSON.parse(localStorage.getItem('user'));
                    user.profilePicture = response.avatarUrl;
                    localStorage.setItem('user', JSON.stringify(user));

                    showAlert('success', 'Foto profil berhasil diperbarui');

                } catch (error) {
                    console.error('Upload avatar error:', error);
                    showAlert('danger', 'Gagal upload foto: ' + error.message);
                    // Reset preview on failure
                    loadProfile();
                } finally {
                    const btn = input.previousElementSibling;
                    btn.disabled = false;
                    btn.innerHTML = originalText; // Restore text
                }
            }
        }

        function switchTab(tabId) {
            // Update Buttons
            document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update Panels
            document.querySelectorAll('.settings-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`section-${tabId}`).classList.add('active');
        }

        // Profile Update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;

            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

                const response = await UsersAPI.updateProfile({ firstName, lastName });

                // Update local storage
                let user = JSON.parse(localStorage.getItem('user'));
                user = { ...user, ...response.user };
                localStorage.setItem('user', JSON.stringify(user));

                showAlert('success', 'Profil berhasil diperbarui');

                // Reload profile data to refresh UI
                await loadProfile();

            } catch (error) {
                showAlert('danger', 'Gagal update profil: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // Password Update
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            const currentPassword = e.target.querySelector('input[type="password"]:nth-of-type(1)').value;
            const newPassword = e.target.querySelector('input[type="password"]:nth-of-type(2)').value;
            const confirmNewPassword = e.target.querySelector('input[type="password"]:nth-of-type(3)').value;

            if (newPassword !== confirmNewPassword) {
                showAlert('danger', 'Konfirmasi password tidak cocok');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

                await UsersAPI.changePassword({ currentPassword, newPassword });

                showAlert('success', 'Password berhasil diubah');
                e.target.reset();

            } catch (error) {
                showAlert('danger', 'Gagal ubah password: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Update Password';
            }
        });

        function toggleApiKey() {
            const display = document.getElementById('apiKeyDisplay');
            if (isKeyVisible) {
                display.textContent = '************************************';
            } else {
                display.textContent = currentApiKey || 'Belum ada API Key';
            }
            isKeyVisible = !isKeyVisible;
        }

        function copyApiKey() {
            if (!currentApiKey) return;
            navigator.clipboard.writeText(currentApiKey);
            showAlert('success', 'API Key disalin ke clipboard');
        }

        async function regenerateApiKey() {
            if (!confirm('Peringatan: Key lama tidak akan berfungsi lagi. Lanjutkan?')) return;

            try {
                const btn = document.querySelector('button[onclick="regenerateApiKey()"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                const response = await UsersAPI.regenerateApiKey();
                currentApiKey = response.apiKey;

                if (isKeyVisible) {
                    document.getElementById('apiKeyDisplay').textContent = currentApiKey;
                }

                showAlert('success', 'API Key baru berhasil digenerate');

            } catch (error) {
                showAlert('danger', 'Gagal generate key: ' + error.message);
            } finally {
                const btn = document.querySelector('button[onclick="regenerateApiKey()"]');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Regenerate API Key';
                }
            }
        }

        // showAlert() function is now provided by toast.js library

        function confirmLogout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>

</html>
