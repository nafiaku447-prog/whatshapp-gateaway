<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - WA Gateway</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/login.css">
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>

<body>
    <div class="back-home">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Kembali</span>
        </a>
    </div>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">
                    <i class="fab fa-whatsapp"></i>
                    <span>WA<span class="highlight">Gateway</span></span>
                </div>
                <h1 class="auth-title">Selamat Datang Kembali!</h1>
                <p class="auth-subtitle">Silakan masuk ke akun Anda</p>
            </div>

            <!-- Error/Success Messages -->
            <div id="error-message"
                style="display: none; padding: 1rem; background: #fee; color: #c00; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
            </div>
            <div id="success-message"
                style="display: none; padding: 1rem; background: #efe; color: #0a0; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <div class="form-input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" class="form-input" placeholder="nama@email.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="form-input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" class="form-input" placeholder="Masukkan password"
                            required>
                    </div>
                </div>

                <div class="form-options">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="remember">
                        <label for="remember">Ingat Saya</label>
                    </div>
                    <a href="#" class="forgot-link">Lupa Password?</a>
                </div>

                <button type="submit" class="btn" id="loginBtn">
                    Masuk
                </button>
            </form>

            <div class="divider">
                <span>atau masuk dengan</span>
            </div>

            <!-- Google Sign-In Button Container -->
            <div id="googleButtonContainer" style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
            </div>

            <div class="auth-footer">
                <p>Belum punya akun? <a href="register.html">Daftar Sekarang</a></p>
            </div>
        </div>
    </div>

    <!-- API Service -->
    <script src="js/api.js"></script>
    <script src="js/google-config.js"></script>

    <script>
        // Redirect if already logged in
        requireGuest();

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            try {
                // Show loading state
                showLoading(loginBtn);

                // Call login API
                const response = await AuthAPI.login(email, password);

                // Show success message
                showSuccess('Login berhasil! Mengalihkan ke dashboard...');

                // Redirect to dashboard after 1 second
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                // Show error message
                showError(error.message || 'Login gagal. Periksa email dan password Anda.');
                hideLoading(loginBtn);
            }
        });

        // GOOGLE SIGN-IN FUNCTIONS
        // ============================================

        // Initialize Google Sign-In when library loads
        window.onload = function () {
            initializeGoogleSignIn();
        };

        function initializeGoogleSignIn() {
            try {
                // Check if Google library is loaded
                if (typeof google === 'undefined') {
                    console.error('Google Sign-In library not loaded');
                    document.getElementById('googleButtonContainer').innerHTML =
                        '<p style="color: #999; font-size: 0.875rem;">Google Sign-In unavailable</p>';
                    return;
                }

                // Initialize Google Sign-In
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleLogin,
                    auto_select: false
                });

                // Render the Google Sign-In button
                google.accounts.id.renderButton(
                    document.getElementById('googleButtonContainer'),
                    {
                        theme: 'outline',
                        size: 'large',
                        width: 350,
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );

            } catch (error) {
                console.error('Failed to initialize Google Sign-In:', error);
            }
        }

        // Handle Google Login Callback
        async function handleGoogleLogin(response) {
            try {
                // Send credential to backend
                const result = await apiRequest('/auth/google', {
                    method: 'POST',
                    body: JSON.stringify({
                        credential: response.credential
                    })
                });

                // Save token and user data
                if (result.token) {
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                }

                // Show success message
                showSuccess(result.isNewUser ?
                    'Account created successfully! Redirecting to dashboard...' :
                    'Login successful! Redirecting to dashboard...'
                );

                // Redirect to dashboard after 1 second
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Google login error:', error);

                // Show error message
                showError(error.message || 'Google login failed. Please try again.');
            }
        }
    </script>
</body>

</html>
