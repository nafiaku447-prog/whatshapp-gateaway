<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - WA Gateway</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/login.css">
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>

<body>
    <div class="back-home">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Kembali</span>
        </a>
    </div>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">
                    <i class="fab fa-whatsapp"></i>
                    <span>WA<span class="highlight">Gateway</span></span>
                </div>
                <h1 class="auth-title">Selamat Datang Kembali!</h1>
                <p class="auth-subtitle">Silakan masuk ke akun Anda</p>
            </div>

            <!-- Error/Success Messages -->
            <div id="error-message"
                style="display: none; padding: 1rem; background: #fee; color: #c00; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
            </div>
            <div id="success-message"
                style="display: none; padding: 1rem; background: #efe; color: #0a0; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
            </div>

            <!-- Login Form (Email & Password) -->
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <div class="form-input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" class="form-input" placeholder="nama@email.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <div class="form-input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" class="form-input" placeholder="Masukkan password"
                            required>
                    </div>
                </div>

                <div class="form-options">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="remember">
                        <label for="remember">Ingat Saya</label>
                    </div>
                    <a href="#" class="forgot-link">Lupa Password?</a>
                </div>

                <button type="submit" class="btn" id="loginBtn">
                    Masuk
                </button>
            </form>

            <!-- Verification Form (Hidden by default) -->
            <div id="verificationSection" style="display: none;">
                <div class="verification-header" style="text-align: center; margin-bottom: 2rem;">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                        <i class="fas fa-envelope-open-text" style="font-size: 2rem; color: white;"></i>
                    </div>
                    <h2 style="color: #1a202c; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Verifikasi
                        Email</h2>
                    <p style="color: #718096; font-size: 0.875rem;">Kode verifikasi telah dikirim ke email Anda</p>
                    <p id="userEmail"
                        style="color: #667eea; font-weight: 600; font-size: 0.875rem; margin-top: 0.5rem;"></p>
                </div>

                <form id="verificationForm">
                    <div class="form-group">
                        <label class="form-label" for="verificationCode">Kode Verifikasi</label>
                        <div class="form-input-wrapper">
                            <i class="fas fa-key"></i>
                            <input type="text" id="verificationCode" class="form-input"
                                placeholder="Masukkan 6 digit kode" maxlength="6" pattern="[0-9]{6}" required
                                style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem; font-weight: 600;">
                        </div>
                        <p style="font-size: 0.75rem; color: #718096; margin-top: 0.5rem; text-align: center;">
                            <i class="fas fa-info-circle"></i> Kode berlaku selama 10 menit
                        </p>
                    </div>

                    <button type="submit" class="btn" id="verifyBtn">
                        <i class="fas fa-check-circle"></i> Verifikasi
                    </button>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <p style="color: #718096; font-size: 0.875rem; margin-bottom: 0.75rem;">Tidak menerima kode?</p>
                        <button type="button" id="resendBtn" class="btn"
                            style="background: transparent; color: #667eea; border: 2px solid #667eea; font-weight: 600;">
                            <i class="fas fa-redo"></i> Kirim Ulang Kode
                        </button>
                        <div id="resendTimer"
                            style="display: none; color: #718096; font-size: 0.75rem; margin-top: 0.5rem;">
                            Kirim ulang dalam <span id="countdown">60</span> detik
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button type="button" id="backToLogin" class="forgot-link"
                            style="text-decoration: none; color: #667eea; font-size: 0.875rem;">
                            <i class="fas fa-arrow-left"></i> Kembali ke Login
                        </button>
                    </div>
                </form>
            </div>

            <div class="divider">
                <span>atau masuk dengan</span>
            </div>

            <!-- Google Sign-In Button Container -->
            <div id="googleButtonContainer" style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
            </div>

            <div class="auth-footer">
                <p>Belum punya akun? <a href="register.html">Daftar Sekarang</a></p>
            </div>
        </div>
    </div>

    <!-- API Service -->
    <script src="js/api.js"></script>
    <script src="js/google-config.js"></script>

    <script>
        // Redirect if already logged in
        requireGuest();

        // Global variables for verification
        let tempLoginData = null;
        let resendCountdown = 60;
        let countdownInterval = null;

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            try {
                // Show loading state
                showLoading(loginBtn);

                // Call login API to verify credentials and send OTP
                const response = await apiRequest('/auth/login-verify', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                // Store temporary data
                tempLoginData = { email, password };

                // Hide login form and show verification section
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('verificationSection').style.display = 'block';
                document.getElementById('userEmail').textContent = email;

                // Start countdown timer
                startResendCountdown();

                // Show success message
                showSuccess('Kode verifikasi telah dikirim ke email Anda');
                hideLoading(loginBtn);

            } catch (error) {
                // Show error message
                showError(error.message || 'Login gagal. Periksa email dan password Anda.');
                hideLoading(loginBtn);
            }
        });

        // Handle verification form submission
        document.getElementById('verificationForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const verificationCode = document.getElementById('verificationCode').value;
            const verifyBtn = document.getElementById('verifyBtn');

            if (!tempLoginData) {
                showError('Session expired. Please login again.');
                resetToLogin();
                return;
            }

            try {
                // Show loading state
                showLoading(verifyBtn);

                // Verify OTP code
                const response = await apiRequest('/auth/verify-otp', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: tempLoginData.email,
                        password: tempLoginData.password,
                        code: verificationCode
                    })
                });

                // Save token and user data
                if (response.token) {
                    localStorage.setItem('token', response.token);
                    localStorage.setItem('user', JSON.stringify(response.user));
                }

                // Show success message
                showSuccess('Verifikasi berhasil! Mengalihkan ke dashboard...');

                // Redirect to dashboard after 1 second
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                // Show error message
                showError(error.message || 'Kode verifikasi tidak valid atau sudah kadaluarsa.');
                hideLoading(verifyBtn);
            }
        });

        // Handle resend button
        document.getElementById('resendBtn').addEventListener('click', async function () {
            if (!tempLoginData) {
                showError('Session expired. Please login again.');
                resetToLogin();
                return;
            }

            try {
                const resendBtn = document.getElementById('resendBtn');
                showLoading(resendBtn);

                // Resend OTP
                await apiRequest('/auth/resend-otp', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: tempLoginData.email
                    })
                });

                showSuccess('Kode verifikasi baru telah dikirim!');
                hideLoading(resendBtn);

                // Restart countdown
                startResendCountdown();

            } catch (error) {
                showError(error.message || 'Gagal mengirim ulang kode.');
                hideLoading(document.getElementById('resendBtn'));
            }
        });

        // Handle back to login button
        document.getElementById('backToLogin').addEventListener('click', function () {
            resetToLogin();
        });

        // Start resend countdown timer
        function startResendCountdown() {
            resendCountdown = 60;
            const resendBtn = document.getElementById('resendBtn');
            const resendTimer = document.getElementById('resendTimer');
            const countdownSpan = document.getElementById('countdown');

            resendBtn.disabled = true;
            resendBtn.style.opacity = '0.5';
            resendBtn.style.cursor = 'not-allowed';
            resendTimer.style.display = 'block';

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                resendCountdown--;
                countdownSpan.textContent = resendCountdown;

                if (resendCountdown <= 0) {
                    clearInterval(countdownInterval);
                    resendBtn.disabled = false;
                    resendBtn.style.opacity = '1';
                    resendBtn.style.cursor = 'pointer';
                    resendTimer.style.display = 'none';
                }
            }, 1000);
        }

        // Reset to login form
        function resetToLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('verificationSection').style.display = 'none';
            document.getElementById('verificationCode').value = '';
            tempLoginData = null;

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        }

        // GOOGLE SIGN-IN FUNCTIONS
        // ============================================

        // Initialize Google Sign-In when library loads
        window.onload = function () {
            initializeGoogleSignIn();
        };

        function initializeGoogleSignIn() {
            try {
                // Check if Google library is loaded
                if (typeof google === 'undefined') {
                    console.error('Google Sign-In library not loaded');
                    document.getElementById('googleButtonContainer').innerHTML =
                        '<p style="color: #999; font-size: 0.875rem;">Google Sign-In unavailable</p>';
                    return;
                }

                // Initialize Google Sign-In
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleLogin,
                    auto_select: false
                });

                // Render the Google Sign-In button
                google.accounts.id.renderButton(
                    document.getElementById('googleButtonContainer'),
                    {
                        theme: 'outline',
                        size: 'large',
                        width: 350,
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );

            } catch (error) {
                console.error('Failed to initialize Google Sign-In:', error);
            }
        }

        // Handle Google Login Callback
        async function handleGoogleLogin(response) {
            try {
                // Send credential to backend
                const result = await apiRequest('/auth/google', {
                    method: 'POST',
                    body: JSON.stringify({
                        credential: response.credential
                    })
                });

                // Save token and user data
                if (result.token) {
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                }

                // Show success message
                showSuccess(result.isNewUser ?
                    'Account created successfully! Redirecting to dashboard...' :
                    'Login successful! Redirecting to dashboard...'
                );

                // Redirect to dashboard after 1 second
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Google login error:', error);

                // Show error message
                showError(error.message || 'Google login failed. Please try again.');
            }
        }
    </script>
</body>

</html>